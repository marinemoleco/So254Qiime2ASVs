## 26.09.2018 ##
## Step 2 - qiime2 ##

# start qiime2
source activate qiime2-2018.8

# make dir for all DADA2 related output files
mkdir DADA2

# import sequence fastq data
# https://docs.qiime2.org/2018.8/tutorials/importing/
qiime tools import \
 --type 'SampleData[PairedEndSequencesWithQuality]' \
 --input-path pe-33-manifest \
 --output-path $PWD/DADA2/bbduk-paired-end-demux.qza \
 --source-format PairedEndFastqManifestPhred33

# DADA2 denoising -> create dada2 based ASVs
# https://docs.qiime2.org/2018.6/tutorials/atacama-soils/
# https://forum.qiime2.org/t/dada2-truncation-lengths-and-features-number/1940/9
qiime dada2 denoise-paired \
 --i-demultiplexed-seqs $PWD/DADA2/bbduk-paired-end-demux.qza \
 --p-trim-left-f 13 \
 --p-trim-left-r 13 \
 --p-trunc-len-f 280 \
 --p-trunc-len-r 220 \
 --p-n-threads 0 \
 --o-table $PWD/DADA2/table.qza \
 --o-representative-sequences $PWD/DADA2/rep-seqs.qza \
 --o-denoising-stats $PWD/DADA2/denoising-stats.qza

# visualize denoising stats
qiime metadata tabulate \
 --m-input-file $PWD/DADA2/denoising-stats.qza \
 --o-visualization $PWD/DADA2/denoising-stats.qzv

qiime tools view $PWD/DADA2/denoising-stats.qzv


# Feature table - first look at your data
# create a qiime view file
qiime feature-table summarize \
 --i-table $PWD/DADA2/DADA2-table.qza \
 --o-visualization $PWD/DADA2/DADA2-table.qzv \
 --m-sample-metadata-file $PWD/2_qiime2_files/metadata.v2.tsv

# view this file
qiime tools view $PWD/DADA2/table.qzv

# Number of samples	305
# Number of features	49,145
# Total frequency	3,724,800

## Step 3 - taxonomy assignment ##
# all sequences will be classified and it seems that any kind of filtering will have no effect on this classification
# hence it makes sense to classify your reads at this point - regardless of any subsequent dataset manipulation
# on my laptop (Ubuntu, 8 threads, 16GB memory, 32GB swap, >500GB temp space) it only worked with 1 job, everything above failed ... memory or temp issue?

qiime feature-classifier classify-sklearn \
  --p-n-jobs 1 \
  --p-reads-per-batch 1000 \
  --i-classifier $PWD/0_training_silva_classifier/Silva132V3V4-classifier.qza \
  --i-reads $PWD/DADA2/rep-seqs.qza \
  --o-classification $PWD/DADA2/Silva132V3V4-taxonomy.qza

qiime metadata tabulate \
  --m-input-file $PWD/DADA2/Silva132V3V4-taxonomy.qza \
  --o-visualization $PWD/DADA2/Silva132V3V4-taxonomy.qzv

qiime tools view $PWD/DADA2/Silva132V3V4-taxonomy.qzv

## Step 4 - filtering ##

# filter samples by metadata IDs - here I just want to keep the sponge, sediment, and seawater samples - I am not interested in the controls or mock or misc samples
qiime feature-table filter-samples \
 --i-table $PWD/DADA2/table.qza \
 --m-metadata-file $PWD/2_qiime2_files/metadata.v2.tsv \
 --p-where "SampleType='Sponge' OR SampleType='Sediment' OR SampleType='Seawater'" \
 --o-filtered-table $PWD/DADA2/table-SpSedSw.qza

# create a qiime view file
qiime feature-table summarize \
 --i-table $PWD/DADA2/table-SpSedSw.qza \
 --o-visualization $PWD/DADA2/table-SpSedSw.qzv \
 --m-sample-metadata-file $PWD/2_qiime2_files/metadata.v2.tsv

# view this file
qiime tools view $PWD/DADA2/table-SpSedSw.qzv

# Number of samples	271
# Number of features	44,349
# Total frequency	3,391,430

# filter samples by feature frequency - very optional & not everyone agrees with that
qiime feature-table filter-features \
 --i-table $PWD/DADA2/table-SpSedSw.qza \
 --p-min-frequency 5 \
 --o-filtered-table $PWD/DADA2/table-SpSedSw.min5.qza

# filter samples by read count
qiime feature-table filter-samples \
 --i-table $PWD/DADA2/table-SpSedSw.min5.qza \
 --p-min-frequency 1500 \
 --o-filtered-table $PWD/DADA2/table-SpSedSw.min5.1500.qza

# create a qiime view file
qiime feature-table summarize \
 --i-table $PWD/DADA2/table-SpSedSw.min5.1500.qza \
 --o-visualization $PWD/DADA2/table-SpSedSw.min5.1500.qzv \
 --m-sample-metadata-file $PWD/2_qiime2_files/metadata.v2.tsv

# view this file
qiime tools view $PWD/DADA2/table-SpSedSw.min5.1500.qzv

# Number of samples	265
# Number of features	38,216
# Total frequency	3,372,510

## Intermediate step here ##

# curate your metadata!
# you will need it soon!

## Step 5 - phylogenetic tree ##
# https://docs.qiime2.org/2018.8/tutorials/moving-pictures/#generate-a-tree-for-phylogenetic-diversity-analyses
# https://docs.qiime2.org/2018.8/plugins/available/phylogeny/align-to-tree-mafft-fasttree/

qiime phylogeny align-to-tree-mafft-fasttree \
  --p-n-threads 0 \
  --i-sequences $PWD/DADA2/rep-seqs.qza \
  --o-alignment $PWD/DADA2/aligned-rep-seqs.qza \
  --o-masked-alignment $PWD/DADA2/masked-aligned-rep-seqs.qza \
  --o-tree $PWD/DADA2/unrooted-tree.qza \
  --o-rooted-tree $PWD/DADA2/rooted-tree.qza
